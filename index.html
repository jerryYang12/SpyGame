<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Spy Game v27.1</title>
    <style>
        :root {
            --bg: #1e1e1e;
            --fg: #e0e0e0;
            --gold: #d4af37;
            --btn: #2e59d9;
            --btn-hover: #4a75f0;
            --muted: #777;
            --card-back-a: #3a3a3a;
            --card-back-b: #2b2b2b;
        }

        html,
        body {
            height: 100%;
            margin: 0
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--fg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 80px 10px 10px;
            box-sizing: border-box;
        }

        .hidden {
            display: none !important;
            opacity: 0;
            visibility: hidden
        }

        #logo {
            text-align: center;
        }

        #logo.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        #logo span {
            display: block;
            font-size: 72px;
            line-height: 1;
        }

        #logo h1 {
            font-size: 26px;
            font-weight: bold;
            color: var(--gold);
            margin: 0
        }

        /* grid */
        #game {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 15px;
            justify-content: center;
            width: 100%;
            max-width: 1000px;
        }

        /* 卡牌 */
        .card {
            position: relative;
            width: 100%;
            height: 0;
            padding-bottom: 150%;
            perspective: 1000px;
            cursor: pointer;
            user-select: none;
            margin-bottom: 10px;
        }

        .inner {
            position: absolute;
            inset: 0;
            transform-style: preserve-3d;
            transition: transform .8s;
        }

        .flipped .inner {
            transform: rotateY(180deg);
        }

        .face,
        .front,
        .back {
            position: absolute;
            inset: 0;
            border-radius: 12px;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 10px;
            box-sizing: border-box;
            flex-direction: column;
            overflow: hidden;
        }

        .back {
            background: linear-gradient(145deg, #3a3a3a, #2b2b2b);
            color: #f5f5f5;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .back::after {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(120deg, transparent, rgba(255, 255, 255, .4), transparent);
            transform: rotate(25deg) translateX(-100%);
            pointer-events: none;
        }

        .card.flipped .back::after {
            animation: shine .8s forwards;
        }

        .card.viewed .back {
            color: #777;
        }

        @keyframes shine {
            0% {
                transform: rotate(25deg) translateX(-100%);
            }

            100% {
                transform: rotate(25deg) translateX(200%);
            }
        }

        .front {
            background: #fff;
            color: #333;
            transform: rotateY(180deg);
        }

        .player-label {
            position: absolute;
            top: -20px;
            left: 0;
            width: 100%;
            text-align: center;
            font-weight: bold;
            color: #fff;
        }

        .execution-result {
            margin-top: 10px;
            font-size: 16px;
            font-weight: bold;
        }

        .execution-result.success {
            color: #4caf50;
        }

        .execution-result.fail {
            color: #f44336;
        }

        /* 按鈕、輸入的共用樣式 */
        button,
        input {
            padding: 10px;
            margin-top: 10px;
            font-size: 16px;
            border-radius: 8px;
            border: none;
            outline: none;
            box-sizing: border-box;
        }

        input {
            background: #2c2c2c;
            color: #f0f0f0;
            border: 1px solid #444;
        }

        input::placeholder {
            color: #bbb;
        }

        .start-inputs {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        #nameInputContainer input {
            display: block;
            margin-bottom: 8px;
            width: 200px;
            padding: 6px 8px;
        }

        /* 抽出的共用按鈕樣式 */
        .btn-primary {
            background: var(--btn);
            color: #fff;
            font-weight: bold;
            letter-spacing: 1px;
            transition: background .3s, transform .2s;
            height: 40px;
            cursor: pointer;
        }

        .btn-primary:hover {
            background: var(--btn-hover);
            transform: scale(1.05);
        }

        #message {
            color: var(--gold);
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 30px;
            display: none;
        }

        /* top buttons group */
        #topButtons {
            position: fixed;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 10px;
            z-index: 10;
        }

        table {
            border-collapse: collapse;
        }

        th,
        td {
            border: 1px solid #999;
            padding: 6px 12px;
            text-align: center;
        }

        #topicDialog {
            padding: 1em;
            border: none;
            border-radius: 8px;
            margin-top: 120px;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: .5em;
        }

        #ruleBox {
            display: none;
            position: fixed;
            top: 60px;
            right: 10px;
            background: #333;
            color: #fff;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 12px;
            z-index: 999;
            max-width: 300px;
            font-size: 14px;
        }

        #rule {
            font-weight: bold;
            margin-bottom: 6px;
        }

        @media (max-width:800px) and (orientation:landscape) {
            #game {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>

<body>
    <div id="topButtons">
        <button id="restartBtn" class="btn-primary hidden">重新遊戲</button>
        <button id="addSetBtn" class="btn-primary hidden">+</button>
        <button id="whiteCardBtn" class="btn-primary hidden">放入白卡</button>
        <button id="langToggle" class="btn-primary">EN</button>
        <button id="ruleToggle" class="btn-primary">R</button>
    </div>

    <div id="logo">
        <span>🕵️</span>
        <h1 id="logoTitle">間諜遊戲</h1>
    </div>

    <div id="start">
        <div class="start-inputs">
            <input id="playerCountInput" type="number" min="2" placeholder="玩家人數" />
            <input id="spyCountInput" type="number" min="1" placeholder="間諜人數 (預設1)" />
            <button id="startBtn" class="btn-primary">開始遊戲</button>
            <div id="nameInputContainer"></div>
            <button id="confirmNamesBtn" class="btn-primary hidden">確定名字</button>
        </div>
    </div>

    <div id="message" class="hidden"></div>
    <div id="game"></div>
    <button id="doneFlipBtn" class="btn-primary hidden">大家都翻完牌了！</button>

    <dialog id="topicDialog" class="clean-dialog">
        <form method="dialog">
            <input type="text" id="civilianInput" placeholder="平民題目" required />
            <input type="text" id="spyInput" placeholder="間諜題目" required />
            <div class="dialog-buttons">
                <button id="cancelSetBtn" type="reset" class="btn-primary">取消</button>
                <button id="confirmSetBtn" type="submit" class="btn-primary">確定</button>
            </div>
        </form>
    </dialog>

    <div id="ruleBox" class="hidden">
        <div id="rule">規則僅供參考: 抓到所有間諜，平民勝。誤殺達標，間諜勝。</div>
        <table>
            <thead>
                <tr>
                    <th id="colPlayer">玩家</th>
                    <th id="colSpy">間諜</th>
                    <th id="colMissKill">誤殺</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>3</td>
                    <td>1</td>
                    <td>1</td>
                </tr>
                <tr>
                    <td>4</td>
                    <td>1</td>
                    <td>1</td>
                </tr>
                <tr>
                    <td>5</td>
                    <td>1</td>
                    <td>2</td>
                </tr>
                <tr>
                    <td>6</td>
                    <td>1</td>
                    <td>2</td>
                </tr>
                <tr>
                    <td>7</td>
                    <td>2</td>
                    <td>2</td>
                </tr>
                <tr>
                    <td>8</td>
                    <td>2</td>
                    <td>3</td>
                </tr>
                <tr>
                    <td>9</td>
                    <td>2</td>
                    <td>3</td>
                </tr>
                <tr>
                    <td>10</td>
                    <td>3</td>
                    <td>4</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- external config: sets / i18n assumed in config.js -->
    <script src="config.js"></script>
    <script>
		const getDOM = (...ids) =>
		  ids.reduce((acc, id) => {
			acc[id] = document.getElementById(id);
			return acc;
		  }, {});

		const DOM = getDOM(
		  'langToggle', 'startBtn', 'confirmNamesBtn', 'restartBtn',
		  'whiteCardBtn', 'addSetBtn', 'doneFlipBtn', 'game',
		  'nameInputContainer', 'message', 'topicDialog', 'spyInput',
		  'civilianInput', 'confirmSetBtn', 'cancelSetBtn', 'ruleToggle',
		  'ruleBox', 'logo', 'playerCountInput', 'spyCountInput', 'logoTitle',
		  'rule', 'colPlayer', 'colSpy', 'colMissKill'
		);

        let currentLang = 'zh',
            flippedState = [],
            cards = [],
            executing = false,
            lock = false,
            playerCount = 0,
            playerNames = [],
            foundSpiesCount = 0,
            whiteCardUsed = false,
            addSetUsed = false,
            spyIndexes = [],
            spyWord = '',
            normalWord = '';

        const show = el => el && (el.classList.remove('hidden'), el.style.setProperty('display', 'block', 'important'));
        const hide = el => el && el.classList.add('hidden');

        const setBtnState = (btn, {
            disabled,
            bg,
            cursor
        }) => {
            if (!btn) return;
            btn.disabled = disabled;
            btn.style.background = bg;
            btn.style.cursor = cursor;
        }

        DOM.ruleToggle.onclick = () => {
            const isHidden = DOM.ruleBox.classList.contains('hidden');
            isHidden ? show(DOM.ruleBox) : hide(DOM.ruleBox);
        };

        DOM.langToggle.onclick = () => {
            currentLang = currentLang === 'zh' ? 'en' : 'zh';
            DOM.langToggle.textContent = currentLang === 'zh' ? 'EN' : '中';
            if (typeof updateText === 'function') updateText();
        };

        DOM.startBtn.onclick = () => {
            const num = +DOM.playerCountInput.value;
            if (!num || num < 3) return alert(i18n[currentLang].alert);
            const spyNum = +DOM.spyCountInput.value || 1;
            if (!spyNum || spyNum < 1 || spyNum >= num) return alert(i18n[currentLang].alert2);

            window.spyNum = spyNum;
            playerCount = num;
            DOM.nameInputContainer.innerHTML = '';
            hide(DOM.message);

            for (let i = 1; i <= playerCount; i++) {
                const input = document.createElement('input');
                input.type = 'text';
                input.placeholder = i18n[currentLang].inputName(i);
                input.id = `playerName${i}`;
                DOM.nameInputContainer.appendChild(input);
            }

            DOM.confirmNamesBtn.textContent = i18n[currentLang].confirmName;
            show(DOM.confirmNamesBtn);
            hide(DOM.startBtn);
            hide(DOM.logo);
            hide(DOM.playerCountInput);
            hide(DOM.spyCountInput);
        };

        DOM.confirmNamesBtn.onclick = () => {
            playerNames = Array.from({
                length: playerCount
            }, (_, i) => {
                const val = document.getElementById(`playerName${i + 1}`)?.value.trim();
                return val || `${Math.floor(1 + Math.random() * 99)}`;
            });
            DOM.message.textContent = i18n[currentLang].flip;
            show(DOM.message);
            hide(DOM.confirmNamesBtn);
            initGame(playerCount, playerNames);
        };

        DOM.doneFlipBtn.onclick = () => {
            executing = true;
            DOM.message.textContent = i18n[currentLang].execute;
            show(DOM.message);
            hide(DOM.doneFlipBtn);
        };

        DOM.whiteCardBtn.onclick = () => {
            if (whiteCardUsed) return;
            const set = (typeof sets !== 'undefined' && sets.length) ? sets[Math.floor(Math.random() * sets.length)] : null;
            while (spyIndexes.length < (window.spyNum || 1)) {
                spyIndexes.push(Math.floor(Math.random() * playerCount));
                spyIndexes = [...new Set(spyIndexes)];
            }
            const whiteCandidates = cards.map((_, i) => i).filter(i => !spyIndexes.includes(i));
            if (!whiteCandidates.length) return;
            const whiteIndex = whiteCandidates[Math.floor(Math.random() * whiteCandidates.length)];
            const card = cards[whiteIndex];
            card.querySelector('.front .img-container')?.remove();
            if (card.querySelector('.front .text-container')) card.querySelector('.front .text-container').textContent = '';
            card.dataset.isWhite = "true";
            whiteCardUsed = true;
            setBtnState(DOM.whiteCardBtn, {
                disabled: true,
                bg: '#A52A2A',
                cursor: 'not-allowed'
            });
        };

        DOM.addSetBtn.onclick = () => {
            if (addSetUsed) return;
            DOM.spyInput.value = '';
            DOM.civilianInput.value = '';
            DOM.dialog.showModal();
        };

        DOM.confirmSetBtn.onclick = e => {
            e.preventDefault();
            const spyW = DOM.spyInput.value.trim(),
                normalW = DOM.civilianInput.value.trim();
            if (spyW && normalW) {
                const customSet = [{
                    text: spyW,
                    img: ''
                }, {
                    text: normalW,
                    img: ''
                }];
                resetBtnStatus();
                initGame(playerCount, playerNames, customSet);
                addSetUsed = true;
                setBtnState(DOM.addSetBtn, {
                    disabled: true,
                    bg: '#A52A2A',
                    cursor: 'not-allowed'
                });
                DOM.dialog.close();
            }
        };

        DOM.cancelSetBtn.onclick = () => DOM.dialog.close();

        DOM.restartBtn.onclick = () => {
            resetBtnStatus();
            initGame(playerCount, playerNames);
        };

        function updateText() {
            if (typeof i18n === 'undefined') return;
            const t = i18n[currentLang];
            document.title = t.title;
            DOM.logoTitle.textContent = t.title;
            DOM.startBtn.textContent = t.start;
            DOM.confirmNamesBtn.textContent = t.confirmName;
            DOM.restartBtn.textContent = t.restart;
            DOM.whiteCardBtn.textContent = t.whiteCard;
            DOM.doneFlipBtn.textContent = t.done;
            DOM.playerCountInput.placeholder = t.placeholderCount;
            DOM.spyCountInput.placeholder = t.spyCountPlaceholder;
            DOM.rule.textContent = t.rule;
            DOM.colPlayer.textContent = t.colPlayer;
            DOM.colSpy.textContent = t.colSpy;
            DOM.colMissKill.textContent = t.colMissKill;
            DOM.civilianInput.placeholder = t.civilianInput;
            DOM.spyInput.placeholder = t.spyInput;
            DOM.confirmSetBtn.textContent = t.confirm;
            DOM.cancelSetBtn.textContent = t.cancel;
            document.querySelectorAll('#nameInputContainer input').forEach((input, i) => input.placeholder = t.inputName(i + 1));
        }

        function checkAllFlipped() {
            flippedState.every(c => c >= 2) ? show(DOM.doneFlipBtn) : hide(DOM.doneFlipBtn);
        }

        const getSpyIndexes = (total, spyNum) => {
            const idx = new Set();
            while (idx.size < spyNum) idx.add(Math.floor(Math.random() * total));
            return [...idx];
        }

        function resetBtnStatus() {
            DOM.game.innerHTML = '';
            spyWord = normalWord = '';
            hide(DOM.doneFlipBtn);
            show(DOM.restartBtn);
            DOM.message.textContent = i18n[currentLang].flip;
            show(DOM.message);
            executing = false;
            flippedState = Array(playerCount).fill(0);
            whiteCardUsed = false;
            setBtnState(DOM.whiteCardBtn, {
                disabled: false,
                bg: '#2e59d9',
                cursor: 'pointer'
            });
            hide(DOM.whiteCardBtn);
            addSetUsed = false;
            setBtnState(DOM.addSetBtn, {
                disabled: false,
                bg: '#2e59d9',
                cursor: 'pointer'
            });
            hide(DOM.addSetBtn);
        }

        function initGame(pc, pNames, customSet = null) {
            hide(document.getElementById('start'));
            DOM.game.style.display = 'grid';
            DOM.game.innerHTML = '';
            show(DOM.restartBtn);
            hide(DOM.doneFlipBtn);
            show(DOM.whiteCardBtn);
            setBtnState(DOM.whiteCardBtn, {
                disabled: false,
                bg: '#2e59d9',
                cursor: 'pointer'
            });
            show(DOM.addSetBtn);
            setBtnState(DOM.addSetBtn, {
                disabled: false,
                bg: '#2e59d9',
                cursor: 'pointer'
            });
            flippedState = Array(pc).fill(0);
            executing = false;
            foundSpiesCount = 0;

            const set = customSet || (typeof sets !== 'undefined' && sets.length ? sets[Math.floor(Math.random() * sets.length)] : [{
                text: '間諜',
                img: ''
            }, {
                text: '平民',
                img: ''
            }]);
            spyWord = set[0];
            normalWord = set[1];
            const spyNum = window.spyNum || 1;
            spyIndexes = getSpyIndexes(pc, spyNum);
            const words = Array(pc).fill().map((_, i) => spyIndexes.includes(i) ? spyWord : normalWord);

            DOM.message.textContent = i18n[currentLang].flip;
            show(DOM.message);

            cards = words.map((word, i) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = createCardHTML(pNames[i], word, i);
                let localLock = false;

                card.addEventListener('click', () => {
                    if (lock || localLock) return;

                    if (!whiteCardUsed) {
                        whiteCardUsed = true;
                        setBtnState(DOM.whiteCardBtn, {
                            disabled: true,
                            bg: 'gray',
                            cursor: 'not-allowed'
                        });
                    }
                    if (!addSetUsed) {
                        addSetUsed = true;
                        setBtnState(DOM.addSetBtn, {
                            disabled: true,
                            bg: 'gray',
                            cursor: 'not-allowed'
                        });
                    }

                    if (!executing) {
                        if (flippedState[i] >= 2) return;
                        if (flippedState.some((c, j) => j !== i && c % 2 === 1)) return;
                        card.classList.toggle('flipped');
                        card.classList.add('viewed');
                        flippedState[i]++;
                        checkAllFlipped();
                        lock = localLock = true;
                        setTimeout(() => {
                            lock = localLock = false
                        }, 500);
                    } else {
                        const execDiv = document.getElementById(`execResult${i}`);
                        if (execDiv?.textContent) return;
                        card.querySelector('.front .img-container')?.style.setProperty('display', 'none');
                        if (card.querySelector('.front .text-container')) card.querySelector('.front .text-container').textContent = '';
                        if (!card.classList.contains('flipped')) card.classList.add('flipped');

                        if (card.dataset.isWhite === "true") {
                            if (execDiv) {
                                execDiv.textContent = '';
                                execDiv.className = '';
                            }
                            return;
                        }

                        if (spyIndexes.includes(i)) {
                            if (execDiv) {
                                execDiv.textContent = i18n[currentLang].spy;
                                execDiv.className = 'execution-result success';
                            }
                            foundSpiesCount++;
                            if (foundSpiesCount === spyIndexes.length) {
                                DOM.message.textContent = `${spyWord.text}🕵️ , ${normalWord.text}`;
                                show(DOM.message);
                            }
                        } else {
                            if (execDiv) {
                                execDiv.textContent = i18n[currentLang].notSpy;
                                execDiv.className = 'execution-result fail';
                            }
                        }
                    }
                });

                DOM.game.appendChild(card);
                return card;
            });

            console.log("DEBUG 平民是：", normalWord.text);
            console.log("DEBUG 間諜是：", spyWord.text);
        }

        function createCardHTML(playerName, word, index) {
            return `
    <div class="player-label">${playerName}</div>
    <div class="inner">
      <div class="face back">${(typeof i18n !== 'undefined' && i18n[currentLang]) ? i18n[currentLang].flipMe : '翻牌'}</div>
      <div class="face front">
        <div class="img-container">${word.img ? `<img src="${word.img}" style="max-width:100%;height:auto;">` : ''}</div>
        <div class="text-container">${word.text}</div>
        <div class="execution-result" id="execResult${index}"></div>
      </div>
    </div>`;
        }
    </script>
</body>

</html>